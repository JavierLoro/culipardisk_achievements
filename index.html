<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Club Deportivo Culipardisk</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <h1>游끥 CULIPARDISK</h1>
        <p class="subtitle">Temporada 2025-2026</p>

        <div id="stats" class="stats"></div>

        <div class="achievements-container">
            <div id="playersList" class="players-list">
                <!-- Se generar치 din치micamente -->
            </div>
        </div>

        <div id="loading" class="loading">Cargando logros...</div>
        <div id="error" class="error" style="display: none;"></div>
    </div>

    <!-- Tooltip flotante -->
    <div id="floatingTooltip" style="position: fixed; display: none; z-index: 999999; background: rgba(0,0,0,0.95); color: white; padding: 10px 14px; border-radius: 8px; font-size: 13px; max-width: 250px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); pointer-events: none;"></div>

    <script>
        // Funciones para el tooltip flotante
        function showTooltip(event, text) {
            const tooltip = document.getElementById('floatingTooltip');
            tooltip.innerHTML = text;
            tooltip.style.display = 'block';
            
            // Posicionar el tooltip
            const x = event.pageX;
            const y = event.pageY;
            
            // Ajustar posici칩n para que no se salga de la pantalla
            tooltip.style.left = x + 10 + 'px';
            tooltip.style.top = (y - tooltip.offsetHeight - 10) + 'px';
            
            // Si se sale por arriba, ponerlo abajo
            if (y - tooltip.offsetHeight - 10 < window.scrollY) {
                tooltip.style.top = (y + 20) + 'px';
            }
            
            // Si se sale por la derecha
            if (x + tooltip.offsetWidth + 10 > window.innerWidth) {
                tooltip.style.left = (x - tooltip.offsetWidth - 10) + 'px';
            }
        }
        
        function hideTooltip() {
            document.getElementById('floatingTooltip').style.display = 'none';
        }
        
        // Mover tooltip con el mouse
        document.addEventListener('mousemove', function(e) {
            const tooltip = document.getElementById('floatingTooltip');
            if (tooltip.style.display === 'block') {
                tooltip.style.left = (e.pageX + 10) + 'px';
                tooltip.style.top = (e.pageY - tooltip.offsetHeight - 10) + 'px';
            }
        });
        class AchievementSystem {
            constructor() {
                this.data = null;
                this.init();
            }

            async init() {
                try {
                    // Para producci칩n:
                    const response = await fetch('logros.json');
                    this.data = await response.json();

                    this.render();
                    this.hideLoading();
                    this.renderStats();
                } catch (error) {
                    this.showError('Error al cargar los datos: ' + error.message);
                }
            }

            // Obtener el logro progresivo m치s alto de cada grupo
            getHighestProgressiveAchievements(jugador) {
                const progresivos = {};

                if (!this.data.logrosProgresivos) {
                    return progresivos;
                }

                this.data.logrosProgresivos.forEach(grupo => {
                    let highestLevel = 0;
                    let highestAchievement = null;

                    grupo.niveles.forEach(nivel => {
                        if (jugador.logrosDesbloqueados.includes(nivel.id) && nivel.nivel > highestLevel) {
                            highestLevel = nivel.nivel;
                            highestAchievement = nivel;
                        }
                    });

                    if (!highestAchievement) {
                        highestAchievement = grupo.niveles[0];
                    }

                    progresivos[grupo.grupo] = {
                        achievement: highestAchievement,
                        unlocked: jugador.logrosDesbloqueados.includes(highestAchievement.id),
                        nextLevel: highestLevel < grupo.niveles.length ? grupo.niveles[highestLevel] : null
                    };
                });

                return progresivos;
            }

            // Calcular puntos del jugador
            getPlayerPoints(jugador) {
                let totalPoints = 0;
                const config = this.data.configuracion?.valoresPorDefecto || {
                    publico: 10,
                    especial: 25,
                    secreto: 15,
                    progresivo_nivel1: 5,
                    progresivo_nivel2: 10,
                    progresivo_nivel3: 20,
                    progresivo_nivel4: 30
                };
                
                jugador.logrosDesbloqueados.forEach(logroId => {
                    // Buscar en logros normales
                    const logro = this.data.logros.find(l => l.id === logroId);
                    if (logro) {
                        totalPoints += logro.valor || config[logro.tipo] || 10;
                    }
                    
                    // Buscar en progresivos
                    if (this.data.logrosProgresivos) {
                        this.data.logrosProgresivos.forEach(grupo => {
                            const nivel = grupo.niveles.find(n => n.id === logroId);
                            if (nivel) {
                                totalPoints += nivel.valor || config[`progresivo_nivel${nivel.nivel}`] || 5;
                            }
                        });
                    }
                });
                
                return totalPoints;
            }

            render() {
                const playersList = document.getElementById('playersList');
                let html = '';

                // Ordenar jugadores por PUNTOS
                const jugadoresOrdenados = [...this.data.jugadores].sort((a, b) => {
                    return this.getPlayerPoints(b) - this.getPlayerPoints(a);
                });

                jugadoresOrdenados.forEach((jugador, index) => {
                    const animationDelay = index * 0.1;
                    const isLeader = index === 0 && jugador.logrosDesbloqueados.length > 0;
                    const points = this.getPlayerPoints(jugador);

                    html += `
                        <div class="player-card ${isLeader ? 'leader' : ''}" style="animation-delay: ${animationDelay}s">
                            <div class="player-header">
                                <div class="player-info">
                                    <h3 class="player-name">${jugador.nombre}</h3>
                                    ${isLeader ? '<span class="leader-badge">游녬</span>' : ''}
                                </div>
                                <span class="achievement-count">${points} pts</span>
                            </div>
                            <div class="achievements-scroll-container">
                                <div class="achievements-grid">
                                    ${this.renderPlayerAchievements(jugador)}
                                </div>
                            </div>
                        </div>
                    `;
                });

                playersList.innerHTML = html;
            }

            // Contar logros 칰nicos totales (progresivos cuentan como 1)
            getTotalUniqueAchievements() {
                let total = this.data.logros.length;
                if (this.data.logrosProgresivos) {
                    total += this.data.logrosProgresivos.length;
                }
                return total;
            }

            renderPlayerAchievements(jugador) {
                let achievementsHTML = '';

                // Separar logros por categor칤as
                const publicosDesbloqueados = [];
                const especialesDesbloqueados = [];
                const secretosDesbloqueados = [];
                const publicosBloqueados = [];
                const especialesBloqueados = [];
                const secretosBloqueados = [];

                // Clasificar todos los logros normales
                this.data.logros.forEach(logro => {
                    const isUnlocked = jugador.logrosDesbloqueados.includes(logro.id);

                    if (logro.tipo === 'secreto') {
                        if (isUnlocked) {
                            secretosDesbloqueados.push(logro);
                        } else {
                            secretosBloqueados.push(logro);
                        }
                    } else if (logro.tipo === 'especial') {
                        if (isUnlocked) {
                            especialesDesbloqueados.push(logro);
                        } else {
                            especialesBloqueados.push(logro);
                        }
                    } else {
                        if (isUnlocked) {
                            publicosDesbloqueados.push(logro);
                        } else {
                            publicosBloqueados.push(logro);
                        }
                    }
                });

                // Obtener y separar progresivos
                const progresivos = this.getHighestProgressiveAchievements(jugador);
                const progresivosArray = Object.values(progresivos);
                const progresivosDesbloqueados = progresivosArray.filter(p => p.unlocked);
                const progresivosBloqueados = progresivosArray.filter(p => !p.unlocked);

                // ORDEN DE RENDERIZADO:
                // 1. P칰blicos y especiales desbloqueados
                [...publicosDesbloqueados, ...especialesDesbloqueados].forEach(logro => {
                    achievementsHTML += this.renderAchievement(logro, true);
                });

                // 2. Secretos desbloqueados
                secretosDesbloqueados.forEach(logro => {
                    achievementsHTML += this.renderAchievement(logro, true);
                });

                // 3. Progresivos desbloqueados
                progresivosDesbloqueados.forEach(prog => {
                    achievementsHTML += this.renderProgressiveAchievement(
                        prog.achievement,
                        true,
                        prog.nextLevel
                    );
                });

                // 4. P칰blicos y especiales bloqueados
                [...publicosBloqueados, ...especialesBloqueados].forEach(logro => {
                    achievementsHTML += this.renderAchievement(logro, false);
                });

                // 5. Progresivos bloqueados
                progresivosBloqueados.forEach(prog => {
                    achievementsHTML += this.renderProgressiveAchievement(
                        prog.achievement,
                        false,
                        prog.nextLevel
                    );
                });

                // 6. Secretos bloqueados
                secretosBloqueados.forEach(logro => {
                    achievementsHTML += this.renderAchievement(logro, false);
                });

                return achievementsHTML;
            }

            renderAchievement(logro, isUnlocked) {
                let imgSrc, tooltipText, imgClass, tooltipClass = '';
                let altText = logro.nombre;

                if (isUnlocked) {
                    imgSrc = logro.imagenDesbloqueada;

                    if (logro.tipo === 'especial') {
                        imgClass = 'achievement-img special-unlocked';
                        tooltipClass = 'special';
                        tooltipText = `<strong>${logro.nombre}</strong><br>${logro.descripcion}`;
                    } else if (logro.tipo === 'publico') {
                        imgClass = 'achievement-img unlocked';
                        tooltipText = `<strong>${logro.nombre}</strong><br>${logro.descripcion}`;
                    } else { // secreto
                        imgClass = 'achievement-img unlocked';
                        tooltipText = `<strong>${logro.descripcion}</strong>`;
                    }
                } else {
                    imgSrc = logro.imagenBloqueada;

                    if (logro.tipo === 'especial') {
                        imgClass = 'achievement-img special-locked';
                        tooltipClass = 'special';
                        tooltipText = `<strong>${logro.nombre}</strong><br>${logro.descripcion}`;
                    } else if (logro.tipo === 'secreto') {
                        imgClass = 'achievement-img secret-locked';
                        tooltipText = '<strong>Secreto</strong>';
                        altText = 'Secreto';
                    } else { // publico
                        imgClass = 'achievement-img locked';
                        tooltipText = `<strong>${logro.nombre}</strong><br>${logro.descripcion}`;
                    }
                }

                return `
                    <div class="achievement-cell" onmouseenter="showTooltip(event, \`${tooltipText.replace(/`/g, '\\`')}\`)" onmouseleave="hideTooltip()">
                        <img src="${imgSrc}" alt="${altText}" class="${imgClass}">
                    </div>
                `;
            }

            renderProgressiveAchievement(logro, isUnlocked, nextLevel) {
                let imgSrc, tooltipText, imgClass, tooltipClass = '';

                if (isUnlocked) {
                    imgSrc = logro.imagenDesbloqueada;

                    const levelIndicator = this.getLevelIndicator(logro.nivel);

                    if (logro.tipo === 'especial') {
                        imgClass = 'achievement-img special-unlocked progressive';
                        tooltipClass = 'special progressive';
                    } else {
                        imgClass = 'achievement-img unlocked progressive';
                        tooltipClass = 'progressive';
                    }

                    tooltipText = `<strong>${logro.nombre} ${levelIndicator}</strong><br>${logro.descripcion}`;

                    if (nextLevel) {
                        tooltipText += `<br><em style="color: #ffd700; font-size: 0.9em;">Pr칩ximo: ${nextLevel.descripcion}</em>`;
                    } else {
                        tooltipText += `<br><em style="color: #4CAF50; font-size: 0.9em;">춰Nivel m치ximo alcanzado!</em>`;
                    }
                } else {
                    imgSrc = logro.imagenBloqueada;
                    imgClass = 'achievement-img locked progressive';
                    tooltipClass = 'progressive';
                    tooltipText = `<strong>${logro.nombre}</strong><br>${logro.descripcion}`;
                }

                const levelBadge = this.getLevelBadge(logro.nivel, isUnlocked);

                return `
                    <div class="achievement-cell progressive-cell" onmouseenter="showTooltip(event, \`${tooltipText.replace(/`/g, '\\`')}\`)" onmouseleave="hideTooltip()">
                        <div class="achievement-wrapper">
                            <img src="${imgSrc}" alt="${logro.nombre}" class="${imgClass}">
                            ${levelBadge}
                        </div>
                    </div>
                `;
            }

            getLevelIndicator(level) {
                const indicators = ['', '游볠', '游볟', '游볞', '游눑'];
                return indicators[level] || '';
            }

            getLevelBadge(level, isUnlocked) {
                if (!isUnlocked) return '';

                const badges = {
                    1: '<span class="level-badge bronze">I</span>',
                    2: '<span class="level-badge silver">II</span>',
                    3: '<span class="level-badge gold">III</span>',
                    4: '<span class="level-badge diamond">IV</span>'
                };

                return badges[level] || '';
            }

            renderStats() {
                const statsDiv = document.getElementById('stats');

                // Calcular estad칤sticas
                const totalJugadores = this.data.jugadores.filter(j => j.logrosDesbloqueados.includes('socio')).length;
                const totalUniqueAchievements = this.getTotalUniqueAchievements();
                
                // Calcular secretos desbloqueados
                const logrosSecretos = this.data.logros.filter(l => l.tipo === 'secreto');
                const secretosDesbloqueados = new Set();
                
                this.data.jugadores.forEach(jugador => {
                    jugador.logrosDesbloqueados.forEach(logroId => {
                        const logro = this.data.logros.find(l => l.id === logroId);
                        if (logro && logro.tipo === 'secreto') {
                            secretosDesbloqueados.add(logroId);
                        }
                    });
                });

                // Calcular puntos totales
                let puntosTotales = 0;
                this.data.jugadores.forEach(jugador => {
                    puntosTotales += this.getPlayerPoints(jugador);
                });

                statsDiv.innerHTML = `
                    <div class="stat-card fade-in">
                        <div class="stat-number">${totalJugadores}</div>
                        <div class="stat-label">Socios</div>
                    </div>
                    <div class="stat-card fade-in" style="animation-delay: 0.1s;">
                        <div class="stat-number">${totalUniqueAchievements}</div>
                        <div class="stat-label">Total logros</div>
                    </div>
                    <div class="stat-card fade-in" style="animation-delay: 0.2s;">
                        <div class="stat-number">${secretosDesbloqueados.size}/${logrosSecretos.length}</div>
                        <div class="stat-label">Secretos revelados</div>
                    </div>
                    <div class="stat-card fade-in" style="animation-delay: 0.3s;">
                        <div class="stat-number">${puntosTotales}</div>
                        <div class="stat-label">Puntos totales</div>
                    </div>
                `;
            }

            hideLoading() {
                document.getElementById('loading').style.display = 'none';
            }

            showError(message) {
                document.getElementById('loading').style.display = 'none';
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        // Inicializar el sistema cuando se carga la p치gina
        document.addEventListener('DOMContentLoaded', () => {
            new AchievementSystem();
        });
    </script>
</body>
</html>